/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

:root {
  --glass-active-border-color: rgb(37, 44, 51);
  --glass-inactive-border-color: rgb(102, 102, 102);
  --glass-shadow-color: hsla(240,5%,5%,0.3);
}

@media (-moz-platform: windows-win7),
       (-moz-platform: windows-win8) {
  @media not (-moz-windows-classic) {
    :root[sizemode="normal"] #toolbar-menubar:not([autohide="true"]) > #menubar-items,
    :root[sizemode="normal"] #toolbar-menubar[autohide="true"][inactive] ~ :is(#TabsToolbar, #nav-bar) > .toolbar-items {
      margin-top: 1px;
    }
    /**
     * Except for Windows 8, Windows 7 Aero and Windows 7 Aero Basic, the
     * -moz-window-button-box appearance on the .titlebar-buttonbox adds an
     * unwanted margin at the top of the button box.
     *
     * For Windows 8 and Windows Aero (which both use the compositor):
     *   We want the -moz-window-button-box applied in the restored case,
     *   and -moz-window-button-box-maximized in the maximized case.
     *
     * For Windows Aero Basic:
     *   The margin is also unwanted in the maximized case, but we want
     *   it in the restored window case.
     */
    :root[sizemode="normal"] .titlebar-buttonbox {
      appearance: auto;
      -moz-default-appearance: -moz-window-button-box;
    }

    @media (-moz-windows-compositor) {
      :root[sizemode="maximized"] .titlebar-buttonbox {
        appearance: auto;
        -moz-default-appearance: -moz-window-button-box-maximized;
      }
    }
  }
}

@media (-moz-windows-compositor) {
  @media not (-moz-platform: windows-win7) {
    @media not (-moz-platform: windows-win8) {
      @media (-moz-windows-default-theme) {
        @media (-moz-windows-accent-color-in-titlebar) {
          :root[tabsintitlebar] {
            /* stylelint-disable-next-line media-query-no-invalid */
            @media (-moz-bool-pref: "browser.theme.windows.accent-color-in-tabs.enabled") {
              --toolbox-non-lwt-bgcolor: ActiveCaption;
              --toolbox-non-lwt-textcolor: CaptionText;
              --toolbox-non-lwt-bgcolor-inactive: InactiveCaption;
              --toolbox-non-lwt-textcolor-inactive: InactiveCaptionText;

              &:not([lwtheme]) #TabsToolbar {
                /* These colors match the Linux/HCM default button colors. We need to
                 * override these on the tabs toolbar because the accent color is
                 * arbitrary, so the hardcoded colors from browser-custom-colors might
                 * not provide sufficient contrast. */
                --toolbarbutton-icon-fill: currentColor;
                --toolbarbutton-hover-background: color-mix(in srgb, currentColor 17%, transparent);
                --toolbarbutton-active-background: color-mix(in srgb, currentColor 30%, transparent);
              }
            }

            &[sizemode="normal"] #navigator-toolbox {
              border-top: .5px solid ActiveBorder;
              &:-moz-window-inactive {
                border-top-color: InactiveBorder;
              }
            }
          }
        }
      }

      /* See bug 1715990 about why we do this ourselves on HCM */
      @media (prefers-contrast) {
        :root[tabsintitlebar]:not([lwtheme]) {
          background-color: ActiveCaption;
          color: CaptionText;
        }

        :root[tabsintitlebar]:not([lwtheme]):-moz-window-inactive {
          background-color: InactiveCaption;
          color: InactiveCaptionText;
        }
      }

      .titlebar-buttonbox,
      .titlebar-button {
        appearance: none !important;
      }

      .titlebar-button {
        appearance: none !important;
        border: none;
        margin: 0 !important;
        padding: 8px 18px;
        color: inherit;

        /* Segoe Fluent Icons is the preferred font for Windows 11, and
         * Segoe MDL2 Assets is there for windows 10. Luckily, the relevant glyphs
         * are the same, so we can just fall back.
         * See: https://learn.microsoft.com/en-us/windows/apps/design/style/segoe-fluent-icons-font */
        font:
          round(10px, env(hairline)) / 1 "Segoe Fluent Icons",
          "Segoe MDL2 Assets"; /* stylelint-disable-line font-family-no-missing-generic-family-keyword */

        /* Win10's tablet mode is non-windowed -- windows can't be moved or resized
           freely. In theory "minimize" might still make sense, but for simplicity we
           just hide everything but "close".
      
           (This is not called for in Win11's tablet mode, which _is_ windowed.)
        */
        :root[win10-tablet-mode] &:not(.titlebar-close) {
          display: none;
        }

        &:focus-visible {
          outline: var(--focus-outline);
          outline-offset: var(--focus-outline-inset);
        }

        > .toolbarbutton-icon {
          display: none;
        }

        &::before {
          display: inline-block;
          content: inherit;

          &:-moz-locale-dir(rtl) {
            transform: scaleX(-1);
          }
        }

        @media (-moz-windows-default-theme) {
          &:hover {
            background-color: light-dark(hsla(0, 0%, 0%, 0.12), hsla(0, 0%, 100%, 0.22));
        
            &:active {
              background-color: light-dark(hsla(0, 0%, 0%, 0.22), hsla(0, 0%, 100%, 0.32));
            }
          }

          &.titlebar-close:hover {
            color: white;
            background-color: hsl(355, 86%, 49%);
        
            &:active {
              background-color: hsl(355, 82%, 69%);
            }
          }
        }

        @media not (-moz-windows-default-theme) {
          background-color: -moz-field;
          color: ButtonText;

          &:hover {
            background-color: SelectedItem;
            color: SelectedItemText;
          }
        }
      }

      .titlebar-min {
        content: "\e921"; /* ChromeMinimize */
        @media (prefers-contrast) {
          content: "\ef2d"; /* ChromeMinimizeContrast */
        }
      }

      .titlebar-max {
        content: "\e922"; /* ChromeMaximize */
        @media (prefers-contrast) {
          content: "\ef2e"; /* ChromeMaximizeContrast */
        }
      }

      .titlebar-restore {
        content: "\e923"; /* ChromeRestore */
        @media (prefers-contrast) {
          content: "\ef2f"; /* ChromeRestoreContrast */
        }
      }

      .titlebar-restore > .toolbarbutton-icon:-moz-locale-dir(rtl) {
        transform: scaleX(-1);
      }

      .titlebar-close {
        content: "\e8bb"; /* ChromeClose */
        @media (prefers-contrast) {
          content: "\ef2c"; /* ChromeCloseContrast */
        }
      }

      @media (-moz-windows-default-theme) {
        #main-menubar > menu {
          appearance: none;
          color: inherit;

          &[_moz-menuactive] {
            background-color: light-dark(hsla(0,0%,0%,.12), hsla(0,0%,100%,.22));
            color: inherit;
        
            @media (prefers-contrast) {
              background-color: -moz-menuhover;
              color: -moz-menuhovertext;
            }
          }
        }

        #toolbar-menubar[brighttext] > #menubar-items > #main-menubar > menu[_moz-menuactive="true"],
        toolbar[brighttext] .titlebar-button:not(.titlebar-close):hover {
          background-color: hsla(0,0%,100%,.22);
        }
        toolbar[brighttext] .titlebar-button:not(.titlebar-close):hover:active {
          background-color: hsla(0,0%,100%,.32);
        }
      }
    }
  }

  @media (-moz-platform: windows-win7),
         (-moz-platform: windows-win8) {
    :root {
      @media not -moz-pref("sidebar.verticalTabs") {
      background-color: transparent;
      }
      appearance: auto;
      -moz-default-appearance: -moz-win-borderless-glass;
    }

    :root[sizemode="maximized"] .titlebar-buttonbox {
      margin-inline-end: 3px;
    }

    /* These should be hidden w/ glass enabled. Windows draws its own buttons. */
    .titlebar-button {
      display: none;
    }

    /* The borders on the glass frame are ours, and inside #browser, and on
     * win7 we want to make sure they are "glassy", so we can't use #browser
     * as the exclude-glass container. We use #appcontent instead. */
    #appcontent {
      appearance: auto;
      -moz-default-appearance: -moz-win-exclude-glass;
    }
  }

  @media (-moz-platform: windows-win8) {
    /* Artificially draw window borders that are covered by lwtheme, see bug 591930.
     * Borders for win7 are below, win10 only needs something like this when
     * drawing in the titlebar (-moz-windows-accent-color-in-titlebar). */
    #main-window[sizemode="normal"] #navigator-toolbox[lwtheme] {
      border-top: 1px solid var(--glass-shadow-color);
    }
  }

  :root[darkwindowframe="true"]:not(:-moz-window-inactive, [lwtheme]) {
    color: white;
  }

  &:not([lwtheme]) #appcontent {
    background-color: -moz-dialog;
  }
}

@media (-moz-windows-glass) {
  @media not -moz-pref("sidebar.verticalTabs") {
  &:not([lwtheme]) #toolbar-menubar {
    text-shadow: 0 0 .5em white, 0 0 .5em white, 0 1px 0 rgba(255,255,255,.4);
  }

  &:not([lwtheme]) #main-menubar:not(:-moz-window-inactive) {
    background-color: rgba(255,255,255,.5);
    color: black;
    border-radius: 4px;
  }
  }

  /* Artificially draw window borders that are covered by lwtheme, see bug 591930.
   * We use a different border for win8, and this win10+ only needs this if
   * drawing in the titlebar (-moz-windows-accent-color-in-titlebar). */
  #main-window[sizemode="normal"] #navigator-toolbox[lwtheme] {
    border-top: 1px solid var(--glass-active-border-color);
    padding-top: 1px;
    box-shadow: 0 1px 0 rgba(255,255,255,.6) inset;
  }

  #main-window[sizemode="normal"] #navigator-toolbox[lwtheme] :-moz-window-inactive {
    border-top-color: var(--glass-inactive-border-color);
  }
}

/* Aero Basic */
@media not (-moz-windows-compositor) {
  @media (-moz-windows-default-theme) {
    :root {
      background-color: rgb(185,209,234);
    }
    :root:-moz-window-inactive {
      background-color: rgb(215,228,242);
    }

    /* Render a window top border for lwthemes: */
    #main-window[tabsintitlebar][sizemode="normal"] #navigator-toolbox[lwtheme] {
      background-image: linear-gradient(to bottom,
            var(--glass-active-border-color) 0, var(--glass-active-border-color) 1px,
            rgba(255,255,255,.6) 1px, rgba(255,255,255,.6) 2px, transparent 2px);
    }

    #main-window[tabsintitlebar][sizemode="normal"] #navigator-toolbox[lwtheme]:-moz-window-inactive {
      background-image: linear-gradient(to bottom,
            var(--glass-inactive-border-color) 0, var(--glass-inactive-border-color) 1px,
            rgba(255,255,255,.6) 1px, rgba(255,255,255,.6) 2px, transparent 2px);
    }
  }

  &:not([lwtheme]) #print-preview-toolbar {
    appearance: auto;
    -moz-default-appearance: -moz-win-browsertabbar-toolbox;
  }
}
